---
title: "Example workflow for exploratory biomarker analysis"
author: "Malgorzata Nowicka"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: yes
    toc_depth: '3'
  html_document:
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: no
      smooth_scroll: yes
header-includes:
  - \renewcommand*{\familydefault}{\sfdefault}
  - \usepackage{hyperref}
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \floatplacement{figure}{H}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage[normalem]{ulem}
---




```{r setup_knitr, include = FALSE, cache = FALSE}
### Packages to compile rmarkdown
library(knitr)
library(rmarkdown)
### Packages for nice tables
library(kableExtra)


font_size <- 11
cache <- 2


knitr::opts_chunk$set(cache = cache, cache.comments = FALSE, echo = TRUE, warning = FALSE, message = FALSE, error = FALSE, fig.width = 6, fig.height = 5, fig.align = "center")




```




```{r library, results="hide", cache = FALSE}

### Packages for data manipulations
library(tidyverse)
library(plyr) # rbind.fill
library(limma) # strsplit2

### Packages for plotting
library(cowplot)
library(RColorBrewer) # brewer.pal
library(ggbeeswarm)

### Packages for survival analysis 
library(gClinBiomarker)
library(survival)
library(survminer)
library(forestplot)


library(devtools)


devtools::load_all()


```




```{r load_data}

### For now I use GOYA data but this has to be replaced with a test data that can be made publically available 
### This data should be loaded from data/


data_goya <- readRDS("/Users/nowickm2/Workspace/GOYA_GALLIUM_FCGR/tmp/data_goya.RDS")
data <- data_goya

variable_names <- readRDS("/Users/nowickm2/Workspace/GOYA_GALLIUM_FCGR/tmp/variable_names.RDS")


```



# Cox regression


```{r cox_regression, results='asis'}


data <- data_goya
tte_var <- "PFS"
censor_var <- "PFS_Censor"
covariate_vars <- c("Treatment_Arm", "IPI_Caterories", "Cell_Of_Origin", "FCGR3A")
return_vars = NULL


wrapper_res <- wrapper_core_cox_regression(data, tte_var = tte_var, censor_var = censor_var, covariate_vars = covariate_vars, return_vars = NULL, variable_names = NULL, caption = NULL, print_nevent = FALSE, print_pvalues = TRUE, print_adjpvalues = TRUE)

  
BiomarkerKable(wrapper_res, caption = "Changes", font_size = 6)



data <- data_goya
tte_var <- "PFS"
censor_var <- "PFS_Censor"
covariate_vars <- c("IPI_Caterories", "FCGR3A")
return_vars = NULL

strat1_var = "Cell_Of_Origin"
strat2_var = "Treatment_Arm"


wrapper_core_cox_regression_strat(data, tte_var = tte_var, censor_var = censor_var, covariate_vars = covariate_vars, return_vars = NULL, strat1_var = strat1_var, strat2_var = strat2_var, variable_names = NULL, caption = NULL, print_nevent = FALSE, print_pvalues = TRUE, print_adjpvalues = TRUE)




  
```














# Barplot


```{r barplot}


data <- data_goya

x_var = "FCGR3A_cat2"
y_var = "Resp_Lugano"


## Default

wrapper_core_bar_plot(data = data, x_var = x_var, y_var = y_var, colors = NULL, variable_names = NULL, title = NULL, subtitle = NULL, tag = NULL, skip_levels = NULL, show_total_counts = TRUE, show_proportions = TRUE, show_total_proportions = FALSE, title.size = 12, ylim = c(0, 100), axis.text.x.angle = 0, axis.text.x.vjust = 0, axis.text.x.hjust = 0.5, geom_text_size = 3, geom_text_vjust = 0.5, background_grid_major = "none")


## Show total proportions

x_var = "Cell_Of_Origin"
y_var = "Ann_Arbor_Stage"

show_total_proportions <- TRUE
skip_levels <- "I"

wrapper_core_bar_plot(data = data, x_var = x_var, y_var = y_var, colors = NULL, variable_names = NULL, title = NULL, subtitle = NULL, tag = NULL, skip_levels = skip_levels, show_total_counts = TRUE, show_proportions = TRUE, show_total_proportions = show_total_proportions, title.size = 12, ylim = c(0, 100), axis.text.x.angle = 0, axis.text.x.vjust = 0, axis.text.x.hjust = 0.5, geom_text_size = 3, geom_text_vjust = 0.5, background_grid_major = "none")



## Remove one x-level

data$Cell_Of_Origin[data$Cell_Of_Origin == "ABC"] <- NA

show_total_proportions <- TRUE
skip_levels <- "I"

wrapper_core_bar_plot(data = data, x_var = x_var, y_var = y_var, colors = NULL, variable_names = NULL, title = NULL, subtitle = NULL, tag = NULL, skip_levels = skip_levels, show_total_counts = TRUE, show_proportions = TRUE, show_total_proportions = show_total_proportions, title.size = 12, ylim = c(0, 100), axis.text.x.angle = 0, axis.text.x.vjust = 0, axis.text.x.hjust = 0.5, geom_text_size = 3, geom_text_vjust = 0.5, background_grid_major = "none")




```


```{r barplot_strat}


data <- data_goya

x_var = "FCGR3A_cat2"
y_var = "Resp_Lugano"

strat1_var = "Treatment_Arm"
strat2_var = "Cell_Of_Origin2"

strat1_var = NULL

wrapper_core_bar_plot_strat(data = data, x_var = x_var, y_var = y_var, strat1_var = strat1_var, strat2_var = strat2_var, colors = NULL, variable_names = NULL, title = NULL, subtitle = NULL, tag = NULL, skip_levels = NULL, show_total_counts = TRUE, show_proportions = TRUE, show_total_proportions = FALSE, title.size = 12, ylim = c(0, 100), axis.text.x.angle = 0, axis.text.x.vjust = 0, axis.text.x.hjust = 0.5, geom_text_size = 3, geom_text_vjust = 0.5, background_grid_major = "none", strat1_nrow = 1, strat1_ncol = NULL, strat2_nrow = NULL, strat2_ncol = 1)





```


# Box plot


```{r Box_plot}


data <- data_goya

x_var <- "Cell_Of_Origin"
y_var <- "FCGR3A"


wrapper_core_box_plot(data = data, x_var = x_var, y_var = y_var, colors = NULL, variable_names = NULL, title = NULL, subtitle = NULL, tag = NULL, show_total_counts = TRUE, point_size = 1.5, title.size = 12, ylim = NULL, axis.text.x.angle = 0, axis.text.x.vjust = 0, axis.text.x.hjust = 0.5, background_grid_major = "none")



```




```{r Box_plot_strat}


devtools::load_all()

data <- data_goya

x_var <- "BCL2_cat2"
y_var <- "FCGR3A"


strat1_var = "Treatment_Arm"
strat2_var = "Cell_Of_Origin2"
strat2_var = NULL


wrapper_core_box_plot_strat(data = data, x_var = x_var, y_var = y_var, strat1_var = strat1_var, strat2_var = strat2_var, colors = NULL, variable_names = NULL, title = NULL, subtitle = NULL, tag = NULL, show_total_counts = TRUE, point_size = 1.5, title.size = 12, ylim = NULL, axis.text.x.angle = 0, axis.text.x.vjust = 0, axis.text.x.hjust = 0.5, background_grid_major = "none", strat1_nrow = 1, strat1_ncol = NULL, strat2_nrow = NULL, strat2_ncol = 1)




```





# KM plot


```{r KM_plot}


data <- data_goya

tte_var <- "PFS"
censor_var <- "PFS_Censor"
covariate_var <- "Ann_Arbor_Stage"


wrapper_core_KM_plot(data = data, tte_var = tte_var, censor_var = censor_var, covariate_var = covariate_var, colors = NULL, variable_names = NULL, title = NULL, subtitle = NULL, tag = NULL, break.time.by = NULL, max_tte = NULL, risk.table = TRUE, conf.int = FALSE, title.size = 12, legend.position = c(0.03, 0.03), legend.justification = c(0, 0), fontsize = 3.5, rel_heights = c(5, 1), background_grid_major = "none")



```




```{r KM_plot_strat, fig.width=10, fig.height=10}


data <- data_goya
tte_var <- "PFS"
censor_var <- "PFS_Censor"
covariate_var <- "FCGR3A_cat2"

strat1_var = "Treatment_Arm"
strat2_var = "Cell_Of_Origin2"
  

wrapper_core_KM_plot_strat(data = data, tte_var = tte_var, censor_var = censor_var, covariate_var = covariate_var, strat1_var = strat1_var, strat2_var = strat2_var, colors = NULL, variable_names = NULL, title = NULL, subtitle = NULL, tag = NULL, break.time.by = NULL, max_tte = NULL, risk.table = TRUE, conf.int = FALSE, title.size = 12, legend.position = c(0.03, 0.03), legend.justification = c(0, 0), fontsize = 3.5, rel_heights = c(5, 1), background_grid_major = "none")



```












































