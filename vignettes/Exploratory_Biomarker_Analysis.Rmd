---
title: "Exploratory biomarker analysis"
author: "Malgorzata Nowicka"
date: "`r Sys.Date()`"
output: 
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: 
      collapsed: false
      smooth_scroll: false
vignette: >
  %\VignetteIndexEntry{Exploratory biomarker analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---




```{r setup_knitr, include = TRUE, cache = FALSE}

### Packages to compile rmarkdown
library(knitr)
library(rmarkdown)
### Packages for nice tables
library(kableExtra)


font_size <- 9
cache <- 0


### Set global option for font_size for bkable in this document 

options(bkable_font_size = font_size)
options(bkable_full_width = TRUE)


knitr::opts_chunk$set(cache = cache, cache.comments = FALSE, echo = TRUE, warning = FALSE, message = FALSE, error = FALSE, fig.width = 6, fig.height = 5, fig.align = "center", tidy=TRUE, tidy.opts = list(width.cutoff = 80))




```




```{r library, results="hide", cache = FALSE}


ggplot2::theme_set(cowplot::theme_cowplot())


library(BiomarkerWrappers)


```




```{r library2, echo = FALSE}

# devtools::load_all()


```




# Load data


`bdata` object contains random survival and biomarker data. It is not expected to observe any biologically meaningful associations. The goal for this data sets is to solely demonstrate the functionality of this package. 



```{r load_data}


data(bdata)



### Dichotomize gene expression into low and high

genes <- c("BCL2", "GeneA", "GeneB", "GeneC", "GeneD")

data_cat2 <- dplyr::mutate_all(bdata[, genes], wrapper_cut_2groups)
  
colnames(data_cat2) <- paste0(genes, "_cat2")


### Stratify gene expression into quartiles

data_cat4 <- dplyr::mutate_all(bdata[, genes], wrapper_cut_quartiles)
  
colnames(data_cat4) <- paste0(genes, "_cat4")


bdata <- cbind(bdata, data_cat2, data_cat4)



```




# Tile plot





```{r, fig.height=4, fig.width=10}


### Plot generated using geom_tile

wrapper_tile_plot1_core(bdata, y_vars = c("BCL2_by_IHC", "BCL2_by_FISH"))


### Plot generated using geom_col. It has substantially smaller size when sample size is large.

wrapper_tile_plot2_core(bdata, y_vars = c("BCL2_by_IHC", "BCL2_by_FISH"))




```







# Log-rank test


```{r log_rank_test, results='asis'}


### Biomarker effect 

data <- bdata
tte_var <- "PFS"
censor_var <- "PFS_Event"

biomarker_vars <- c("GeneA_cat2", "GeneB_cat2")

strat1_var = "Treatment_Arm"


wrapper_log_rank_test_biomarker(data, tte_var = tte_var, censor_var = censor_var, biomarker_vars = biomarker_vars, strat1_var = strat1_var, print_nevent = TRUE, print_mst = TRUE)




### Treatment effect within biomarker subgroups

data <- bdata
tte_var <- "PFS"
censor_var <- "PFS_Event"

treatment_var = "Treatment_Arm"
biomarker_vars <- c("GeneA_cat2", "GeneB_cat2")


wrapper_log_rank_test_treatment(data, tte_var = tte_var, censor_var = censor_var, treatment_var = treatment_var, biomarker_vars = biomarker_vars)
  



```





# Cox regression


```{r cox_regression, results='asis', fig.width=20, fig.height=4}


### Biomarker effect 

data <- bdata
tte_var <- "PFS"
censor_var <- "PFS_Event"

biomarker_vars <- c("GeneA_cat2", "GeneA")
adjustment_vars <- "IPI"

strat1_var = "Treatment_Arm"


wrapper_cox_regression_biomarker(data, tte_var = tte_var, censor_var = censor_var, biomarker_vars = biomarker_vars, adjustment_vars = adjustment_vars, strat1_var = strat1_var)


## To represent the results with a forest plot

x <- wrapper_cox_regression_biomarker(data, tte_var = tte_var, censor_var = censor_var, biomarker_vars = biomarker_vars, adjustment_vars = adjustment_vars, strat1_var = strat1_var, print_total = FALSE, print_adjpvalues = FALSE)

bforest(x)




### Treatment effect within biomarker subgroups

data <- bdata
tte_var <- "PFS"
censor_var <- "PFS_Event"

treatment_var = "Treatment_Arm"
biomarker_vars <- c("GeneA_cat2", "GeneB_cat2")
adjustment_vars <- "IPI"


wrapper_cox_regression_treatment(data, tte_var = tte_var, censor_var = censor_var, treatment_var = treatment_var, biomarker_vars = biomarker_vars, adjustment_vars = adjustment_vars)
  

## To represent the results with a forest plot

x <- wrapper_cox_regression_treatment(data, tte_var = tte_var, censor_var = censor_var, treatment_var = treatment_var, biomarker_vars = biomarker_vars, adjustment_vars = adjustment_vars, print_total = FALSE, print_adjpvalues = FALSE)


bforest(x)




### Treatment-biomarker interaction effect 


data <- bdata
tte_var <- "PFS"
censor_var <- "PFS_Event"

treatment_var = "Treatment_Arm"
biomarker_vars <- c("GeneA_cat2", "GeneA")
adjustment_vars <- "IPI"



wrapper_cox_regression_interaction(data, tte_var, censor_var, treatment_var = treatment_var, biomarker_vars = biomarker_vars, adjustment_vars = adjustment_vars)
  
  


```





# KM plot


```{r KM_plot}


data <- bdata

tte_var <- "PFS"
censor_var <- "PFS_Event"
covariate_var <- "Treatment_Arm"


wrapper_KM_plot_core(data = data, tte_var = tte_var, censor_var = censor_var, covariate_var = covariate_var)


```




```{r KM_plot_strat, fig.width=10, fig.height=15}


data <- bdata
tte_var <- "PFS"
censor_var <- "PFS_Event"
covariate_var <- "GeneA_cat2"

strat1_var = "Treatment_Arm"
strat2_var = "Cell_Of_Origin"
  

wrapper_KM_plot_core_strat(data = data, tte_var = tte_var, censor_var = censor_var, covariate_var = covariate_var, strat1_var = strat1_var, strat2_var = strat2_var, linetypes = c(2, 1))



```



```{r KM_plot_interaction}


data <- bdata
tte_var <- "PFS"
censor_var <- "PFS_Event"

biomarker_var <- "GeneA_cat2"
treatment_var = "Treatment_Arm"


wrapper_KM_plot_interaction(data, tte_var = tte_var, censor_var = censor_var, biomarker_var = biomarker_var, treatment_var = treatment_var)


wrapper_KM_plot_interaction(data, tte_var = tte_var, censor_var = censor_var, biomarker_var = biomarker_var, treatment_var = treatment_var, colors = c("blue", "blue2", "red", "red2"), linetypes = c(2, 1, 2, 1))



```



```{r KM_plot_biomarker, fig.width=10}


data <- bdata
tte_var <- "PFS"
censor_var <- "PFS_Event"

biomarker_var <- "GeneA_cat2"
treatment_var = "Treatment_Arm"


wrapper_KM_plot_biomarker(data, tte_var = tte_var, censor_var = censor_var, biomarker_var = biomarker_var, treatment_var = treatment_var)


```





```{r KM_plot_treatment, fig.width=10}


data <- bdata
tte_var <- "PFS"
censor_var <- "PFS_Event"

biomarker_var <- "GeneA_cat2"
treatment_var = "Treatment_Arm"


wrapper_KM_plot_treatment(data, tte_var = tte_var, censor_var = censor_var, biomarker_var = biomarker_var, treatment_var = treatment_var)



```




# Logistic regression


```{r logistic_regression, results='asis'}


### Biomarker effect 

data <- bdata
response_var <- "ORR"

biomarker_vars <- c("GeneA_cat2", "GeneA")
adjustment_vars <- "IPI"

strat1_var = "Treatment_Arm"


wrapper_logistic_regression_biomarker(data, response_var =  response_var, biomarker_vars = biomarker_vars, adjustment_vars = adjustment_vars, strat1_var = strat1_var)




### Treatment effect within biomarker subgroups

data <- bdata
response_var <- "ORR"

treatment_var = "Treatment_Arm"
biomarker_vars <- c("GeneA_cat2", "GeneB_cat2")
adjustment_vars <- "IPI"


wrapper_logistic_regression_treatment(data, response_var =  response_var, treatment_var = treatment_var, biomarker_vars = biomarker_vars, adjustment_vars = adjustment_vars)
  


### Treatment-biomarker interaction effect 


data <- bdata
response_var <- "ORR"

treatment_var = "Treatment_Arm"
biomarker_vars <- c("GeneA_cat2", "GeneA")
adjustment_vars <- "IPI"



wrapper_logistic_regression_interaction(data, response_var =  response_var, treatment_var = treatment_var, biomarker_vars = biomarker_vars, adjustment_vars = adjustment_vars)
  
  


```



# Pearson's test


```{r pearsons_test, results='asis'}


data <- bdata
response_var <- "ORR"
treatment_var = "Treatment_Arm"


wrapper_pearsons_test_treatment(data, response_var = response_var, treatment_var = treatment_var)




```



# Cochran-Mantel-Haenszel Chi-Squared Test


```{r mantel_test, results='asis'}


data <- bdata
response_var <- "ORR"
treatment_var = "Treatment_Arm"
strata_vars <- "IPI"

wrapper_pearsons_test_treatment(data, response_var = response_var, treatment_var = treatment_var, strata_vars = strata_vars)




```




# Barplot


```{r barplot}


data <- bdata

x_var = "GeneA_cat2"
y_var = "Response"


wrapper_bar_plot_core(data = data, x_var = x_var, y_var = y_var)




data <- bdata

x_var = "GeneA_cat2"
y_var = "Response"
facet_var <- "Treatment_Arm"
  

wrapper_bar_plot_core(data = data, x_var = x_var, y_var = y_var, facet_var = facet_var)



data <- bdata

x_var = "GeneA_cat2"
y_var = "Response"
skip_levels <- c("NE", "PD", "SD")
show_total_proportions <- TRUE

wrapper_bar_plot_core(data = data, x_var = x_var, y_var = y_var, show_total_proportions = show_total_proportions, skip_levels = skip_levels, ylim = c(0, 100))



```


```{r barplot_strat, fig.height=15, fig.width=10}


data <- bdata

x_var = "GeneA_cat2"
y_var = "Response"

strat1_var = "Treatment_Arm"
strat2_var = "Cell_Of_Origin"


wrapper_bar_plot_core_strat(data = data, x_var = x_var, y_var = y_var, strat1_var = strat1_var, strat2_var = strat2_var)


wrapper_bar_plot_core_strat(data = data, x_var = x_var, y_var = y_var, strat1_var = strat1_var, strat2_var = strat2_var, less_legends = TRUE)



```




# Complex barplot


```{r Complex_barplot, fig.height=5, fig.width=10}


data <- bdata

x_var <- "Cell_Of_Origin"
y_vars <- c("GeneA_cat2", "GeneB_cat2", "GeneC_cat2")


wrapper_bar_plot_yvars_core_strat(data, x_var = x_var, y_vars = y_vars, values_to = "Gene expression")




data <- bdata

x_var <- "Cell_Of_Origin"
y_vars <- c("GeneA_cat2", "GeneB_cat2", "GeneC_cat2")

skip_levels <- "low"
method <- "dodge"


wrapper_bar_plot_yvars_core_strat(data, x_var = x_var, y_vars = y_vars, skip_levels = skip_levels, method = method, values_to = "Gene expression", names_to = "Gene")





```



# Box plot


```{r Box_plot, fig.height=5, fig.width=7}


data <- bdata

x_var <- "Cell_Of_Origin"
y_var <- "GeneA"


wrapper_box_plot_core(data = data, x_var = x_var, y_var = y_var)




```




```{r Box_plot_strat, fig.height=5, fig.width=8}



data <- bdata

x_var <- "Cell_Of_Origin"
y_var <- "GeneA"
facet_var <- "Treatment_Arm"
dodge_var = NULL


wrapper_box_plot_core(data = data, x_var = x_var, y_var = y_var, facet_var = facet_var, dodge_var = dodge_var)




data <- bdata

x_var <- "Treatment_Arm"
y_var <- "GeneA"
facet_var <- NULL
dodge_var = "Cell_Of_Origin"


wrapper_box_plot_core(data = data, x_var = x_var, y_var = y_var, facet_var = facet_var, dodge_var = dodge_var)




data <- bdata

x_var <- "Cell_Of_Origin"
y_var <- "GeneA"


strat1_var = "Treatment_Arm"


wrapper_box_plot_core_strat(data = data, x_var = x_var, y_var = y_var, strat1_var = strat1_var)



```





# Complex boxplot




```{r complex_boxplot, fig.width = 10}


data <- bdata
y_vars <- c("GeneA", "GeneB", "GeneC")


wrapper_box_plot_yvars_core_strat(data, y_vars = y_vars)




data <- bdata
y_vars <- c("GeneA", "GeneB", "GeneC")

x_var = "Cell_Of_Origin"
facet_var = NULL
dodge_var = NULL


wrapper_box_plot_yvars_core_strat(data, y_vars = y_vars, x_var = x_var, facet_var = facet_var, dodge_var = dodge_var)



data <- bdata
y_vars <- c("GeneA", "GeneB", "GeneC")

x_var = NULL
facet_var = NULL
dodge_var = "Cell_Of_Origin"


wrapper_box_plot_yvars_core_strat(data, y_vars = y_vars, x_var = x_var, facet_var = facet_var, dodge_var = dodge_var)




```






# Point plot



```{r Point_plot}


data <- bdata

x_var <- "GeneA"
y_var <- "GeneB"


wrapper_point_plot_core(data = data, x_var = x_var, y_var = y_var)



```



```{r Point_plot_strat, fig.width = 12}


data <- bdata

x_var <- "GeneA"
y_var <- "GeneB"
facet_var <- "Treatment_Arm"
color_point_var <- "Cell_Of_Origin"


wrapper_point_plot_core(data = data, x_var = x_var, y_var = y_var, facet_var = facet_var, color_point_var = color_point_var)




data <- bdata

x_var <- "GeneD"
y_var <- "GeneB"
facet_var <- "Treatment_Arm"
strat1_var <- "Cell_Of_Origin"


wrapper_point_plot_core_strat(data = data, x_var = x_var, y_var = y_var, facet_var = facet_var, strat1_var =  strat1_var)



```







# Kruskal–Wallis H test


```{r kruskal_test, results='asis'}

devtools::load_all()


data <- bdata

cat_vars <- "Cell_Of_Origin"
num_vars <- c("GeneA", "GeneB")


wrapper_kruskal_test(data, num_vars = num_vars, cat_vars = cat_vars)
  
wrapper_kruskal_test(data, num_vars = num_vars, cat_vars = cat_vars, print_pvalues = FALSE)
  


data <- bdata

cat_vars <- c("Cell_Of_Origin", "IPI", "Treatment_Arm")
num_vars <- "GeneA"


wrapper_kruskal_test(data, num_vars = num_vars, cat_vars = cat_vars)
 
 
  
  

```






# Fisher's test


```{r fishers_test, results='asis'}


data <- bdata

col_var <- "ORR"
row_var <- "Treatment_Arm"


wrapper_fishers_test_core(data, col_var = col_var, row_var = row_var)




```








# Characteristics of ITT and BEP


```{r characteristics, results='asis'}



data <- bdata

strat_var <- "Treatment_Arm"
covariate_vars <- c("Age", "IPI")


wrapper_characteristics_core(data, strat_var = strat_var, covariate_vars = covariate_vars)
  
  


bep_vars <- "BEP_RNAseq"
covariate_vars <- c("Age", "IPI")

treatment_var <- "Treatment_Arm"
itt_name = "ITT"


wrapper_characteristics_bep(data, covariate_vars = covariate_vars, bep_vars = bep_vars, treatment_var = treatment_var, itt_name = itt_name)


  
```





```{r}

sessionInfo()

```



















































