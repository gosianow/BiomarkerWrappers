---
title: "Example workflow for exploratory biomarker analysis"
author: "Malgorzata Nowicka"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: yes
    toc_depth: 3
  html_document:
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: no
      smooth_scroll: yes
header-includes:
  - \renewcommand*{\familydefault}{\sfdefault}
  - \usepackage{hyperref}
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \floatplacement{figure}{H}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage[normalem]{ulem}
---




```{r setup_knitr, include = FALSE, cache = FALSE}
### Packages to compile rmarkdown
library(knitr)
library(rmarkdown)
### Packages for nice tables
library(kableExtra)


font_size <- 11
cache <- 0


knitr::opts_chunk$set(cache = cache, cache.comments = FALSE, echo = TRUE, warning = FALSE, message = FALSE, error = FALSE, fig.width = 6, fig.height = 5, fig.align = "center")




```




```{r library, results="hide", cache = FALSE}

### Packages for data manipulations
library(tidyverse)
library(plyr) # rbind.fill
library(limma) # strsplit2

### Packages for plotting
library(cowplot)
library(RColorBrewer) # brewer.pal
library(ggbeeswarm)

### Packages for survival analysis 
library(gClinBiomarker)
library(survival)
library(survminer)
library(forestplot)


library(devtools)


devtools::load_all()


```




```{r load_data}

### For now I use GOYA data but this has to be replaced with a test data that can be made publically available 
### This data should be loaded from data/


data_goya <- readRDS("/Users/nowickm2/Workspace/GOYA_GALLIUM_FCGR/tmp/data_goya.RDS")
data <- data_goya

variable_names <- readRDS("/Users/nowickm2/Workspace/GOYA_GALLIUM_FCGR/tmp/variable_names.RDS")


```




# Characteristics


```{r characteristics, results='asis'}


data <- data_goya

x_var <- "Treatment_Arm"
y_var <- "Ann_Arbor_Stage"

variable_names = NULL
caption = NULL



wrapper_core_characteristics_cat(data, x_var = x_var, y_var = y_var)


x_var <- "Treatment_Arm"
y_var <- "FCGR2B"

variable_names = NULL
caption = NULL



wrapper_core_characteristics_num(data, x_var = x_var, y_var = y_var)


data <- data_goya

x_var <- "Treatment_Arm"
y_vars <- c("FCGR2B", "Ann_Arbor_Stage")


wrapper_core_characteristics(data, x_var = x_var, y_vars = y_vars)
  
  
  
```




# Fisher's test


```{r fishers_test, results='asis'}


data <- data_goya

x_var <- "Cell_Of_Origin"
y_var <- "Ann_Arbor_Stage"


variable_names = NULL
caption = NULL

margin = 1
print_pvalues = TRUE



wrapper_core_fishers_test(data, x_var = x_var, y_var = y_var, margin = margin)



x_var <- "Cell_Of_Origin2"
y_var <- "FCGR2B_cat2"


wrapper_core_fishers_test(data, x_var = x_var, y_var = y_var, margin = margin)



y_var <- "Cell_Of_Origin2"
x_var <- "FCGR2B_cat2"


wrapper_core_fishers_test(data, x_var = x_var, y_var = y_var, margin = margin)




```



# KM plot


```{r KM_plot}


data <- data_goya

tte_var <- "PFS"
censor_var <- "PFS_Censor"
covariate_var <- "Ann_Arbor_Stage"


wrapper_core_KM_plot(data = data, tte_var = tte_var, censor_var = censor_var, covariate_var = covariate_var)



```




```{r KM_plot_strat, fig.width=10, fig.height=10}


data <- data_goya
tte_var <- "PFS"
censor_var <- "PFS_Censor"
covariate_var <- "FCGR3A_cat2"

strat1_var = "Treatment_Arm"
strat2_var = "Cell_Of_Origin2"
  

wrapper_core_KM_plot_strat(data = data, tte_var = tte_var, censor_var = censor_var, covariate_var = covariate_var, strat1_var = strat1_var, strat2_var = strat2_var)



```



```{r KM_plot_interaction}


data <- data_goya
tte_var <- "PFS"
censor_var <- "PFS_Censor"

biomarker_var <- "FCGR3A_cat2"
treatment_var = "Treatment_Arm"



wrapper_KM_plot_interaction(data, tte_var = tte_var, censor_var = censor_var, biomarker_var = biomarker_var, treatment_var = treatment_var)



```






# Cox regression


```{r cox_regression, results='asis'}



data <- data_goya
tte_var <- "PFS"
censor_var <- "PFS_Censor"
covariate_vars <- c("Treatment_Arm", "IPI_Caterories", "Cell_Of_Origin", "FCGR3A")


wrapper_res <- wrapper_core_cox_regression_simple(data, tte_var = tte_var, censor_var = censor_var, covariate_vars = covariate_vars)

  
Bkable(wrapper_res, caption = "Changes", font_size = 6)



data <- data_goya
tte_var <- "PFS"
censor_var <- "PFS_Censor"
covariate_vars <- c("IPI_Caterories", "FCGR3A")

strat1_var = "Cell_Of_Origin"
strat2_var = "Treatment_Arm"


wrapper_core_cox_regression_simple_strat(data, tte_var = tte_var, censor_var = censor_var, covariate_vars = covariate_vars, strat1_var = strat1_var, strat2_var = strat2_var)



data <- data_goya
tte_var <- "PFS"
censor_var <- "PFS_Censor"

biomarker_vars <- c("FCGR2B_cat2", "FCGR3A", "FCGR3A_cat2")
adjustment_vars <- "IPI_Caterories"

strat1_var = "Treatment_Arm"


wrapper_cox_regression_biomarker(data, tte_var = tte_var, censor_var = censor_var, biomarker_vars = biomarker_vars, adjustment_vars = adjustment_vars, strat1_var = strat1_var)





data <- data_goya
tte_var <- "PFS"
censor_var <- "PFS_Censor"

treatment_var = "Treatment_Arm"
biomarker_vars <- c("FCGR2B_cat2", "FCGR3A_cat2")
adjustment_vars <- "IPI_Caterories"

strat2_var = "Cell_Of_Origin"


wrapper_cox_regression_treatment(data, tte_var = tte_var, censor_var = censor_var, treatment_var = treatment_var, biomarker_vars = biomarker_vars, adjustment_vars = adjustment_vars, strat2_var = strat2_var)
  




data <- data_goya
tte_var <- "PFS"
censor_var <- "PFS_Censor"

interaction1_var <- "FCGR3A_cat2"
interaction2_var <- "Treatment_Arm"
covariate_vars <- c("IPI_Caterories", "Cell_Of_Origin")



wrapper_core_cox_regression_interaction(data, tte_var = tte_var, censor_var = censor_var, interaction1_var = interaction1_var, interaction2_var = interaction2_var, covariate_vars = covariate_vars)




data <- data_goya
tte_var <- "PFS"
censor_var <- "PFS_Censor"

interaction1_var <- "FCGR3A_cat2"
interaction2_var <- "Treatment_Arm"
covariate_vars <- c("IPI_Caterories")

strat1_var = "Cell_Of_Origin"
strat2_var = NULL

wrapper_core_cox_regression_interaction_strat(data, tte_var = tte_var, censor_var = censor_var, interaction1_var = interaction1_var, interaction2_var = interaction2_var, covariate_vars = covariate_vars, strat1_var = strat1_var, strat2_var = strat2_var)




data <- data_goya
tte_var <- "PFS"
censor_var <- "PFS_Censor"

treatment_var = "Treatment_Arm"
biomarker_vars <- c("FCGR2B_cat2", "FCGR3A_cat2")
adjustment_vars <- "IPI_Caterories"

strat1_var = NULL
strat2_var = "Cell_Of_Origin"




wrapper_cox_regression_interaction(data, tte_var, censor_var, treatment_var = treatment_var, biomarker_vars = biomarker_vars, adjustment_vars = adjustment_vars, strat1_var = strat1_var, strat2_var = strat2_var)
  
  


```














# Barplot


```{r barplot}


data <- data_goya

x_var = "FCGR3A_cat2"
y_var = "Resp_Lugano"


## Default

wrapper_core_bar_plot(data = data, x_var = x_var, y_var = y_var)


## Show total proportions

x_var = "Cell_Of_Origin"
y_var = "Ann_Arbor_Stage"

show_total_proportions <- TRUE
skip_levels <- "I"

wrapper_core_bar_plot(data = data, x_var = x_var, y_var = y_var, skip_levels = skip_levels)



## Remove one x-level

data$Cell_Of_Origin[data$Cell_Of_Origin == "ABC"] <- NA

show_total_proportions <- TRUE
skip_levels <- "I"

wrapper_core_bar_plot(data = data, x_var = x_var, y_var = y_var, skip_levels = skip_levels, show_total_proportions = show_total_proportions)




```


```{r barplot_strat}


data <- data_goya

x_var = "FCGR3A_cat2"
y_var = "Resp_Lugano"

strat1_var = "Treatment_Arm"
strat2_var = "Cell_Of_Origin2"

strat1_var = NULL

wrapper_core_bar_plot_strat(data = data, x_var = x_var, y_var = y_var, strat1_var = strat1_var, strat2_var = strat2_var)





```


# Box plot


```{r Box_plot}


data <- data_goya

x_var <- "Cell_Of_Origin"
y_var <- "FCGR3A"


wrapper_core_box_plot(data = data, x_var = x_var, y_var = y_var)



```




```{r Box_plot_strat}


data <- data_goya

x_var <- "BCL2_cat2"
y_var <- "FCGR3A"


strat1_var = "Treatment_Arm"
strat2_var = "Cell_Of_Origin2"


wrapper_core_box_plot_strat(data = data, x_var = x_var, y_var = y_var, strat1_var = strat1_var, strat2_var = strat2_var)




```












































