
###############################################################################
### Set class unions
###############################################################################

### To allow caption = NULL
setClassUnion("characterNULL", c("character", "NULL"))

### To allow header = NULL
setClassUnion("integernumericNULL", c("integer", "numeric", "NULL"))


###############################################################################
### Bclass class which is a virtual class
###############################################################################


#' Bclass object
#' 
#' A Bclass object is a container for results generated by the wrappers.
#' 
#' @details 
#' 
#' Methods:
#' 
#' \itemize{ 
#' \item \code{bresults(x)}: Get a data frame with results. 
#' \item \code{boutput(x)}: Get a data frame with output that is dispalyed with kable.
#' \item \code{bcaption(x)}: Get a string with caption that is displayed with kable.
#' \item \code{bheader(x)}: Get a vector with header that is displayed with kable.
#' \item \code{bkable(x)}: Display output with kable.
#' \item \code{bforest(x)}: Generate a forest plot. 
#' }
#' 
#' Inheriting classes:
#' 
#' \itemize{
#' \item \code{Bclass}
#' }
#' 
#' 
#' @param object,x Bclass object.
#' @param value New values.
#'   
#' @slot results Data frame with results.
#' @slot output Data frame with output that is dispalyed with kable.
#' @slot caption String with caption that is displayed in the table.
#' @slot header Names integer vector with header that is displayed in the table.
#'   
#' @author Malgorzata Nowicka
Bclass <- setClass("Bclass", 
  slots = c(results = "data.frame", 
    output = "data.frame",
    caption = "characterNULL",
    header = "integernumericNULL"),
  prototype = list(results = data.frame(), 
    output = data.frame(),
    caption = NULL,
    header = NULL))



# --------------------------------------------------------------------------
# Object validation
# --------------------------------------------------------------------------


setValidity("Bclass", function(object){
  # It has to return TRUE when valid object!
  
  if(nrow(object@results) == nrow(object@output)){
    out <- TRUE
  }else{
    return(paste0("Different number of rows for 'results' and 'output'!"))
  }
  
  ### Check about the rownames
  if(!is.null(rownames(object@results)) || !is.null(rownames(object@output))){
    if(all(rownames(object@results) == rownames(object@output))){
      out <- TRUE
    }else{
      return(paste0("Different row names for 'results' and 'output'!"))
    }
  }
  
  
  if(!is.null(object@header)){
    if(sum(object@header) == ncol(object@output)){
      out <- TRUE
    }else{
      return(paste0("Sum of values in 'header' must be equal to the number of columns in 'output'!"))
    }
  }
  
  return(out)
  
})



################################################################################
### Generics for the show method
################################################################################


#' @rdname Bclass-class
#' @export
setGeneric("bkable", function(x, ...) standardGeneric("bkable"))


#' @rdname Bclass-class
#' @export
setGeneric("bforest", function(x, ...) standardGeneric("bforest"))


################################################################################
### Accessor methods
################################################################################


### results


#' @rdname Bclass-class
#' @export
setGeneric("bresults", function(x, ...) standardGeneric("bresults"))


#' @rdname Bclass-class
#' @export
setMethod("bresults", "Bclass", function(x) x@results )


#' @rdname Bclass-class
#' @export
setMethod("bresults", "NULL", function(x) NULL )



#' @rdname Bclass-class
#' @export
setGeneric("bresults<-", function(x, value) standardGeneric("bresults<-"))


#' @rdname Bclass-class
#' @export
setMethod("bresults<-", "Bclass", function(x, value){
  
  # x <- Bclass(results = value, output = boutput(x), caption = bcaption(x), header = bheader(x))
  
  x@results <- value
  
  validObject(x)
  
  x
  
})




### output


#' @rdname Bclass-class
#' @export
setGeneric("boutput", function(x, ...) standardGeneric("boutput"))


#' @rdname Bclass-class
#' @export
setMethod("boutput", "Bclass", function(x) x@output )


#' @rdname Bclass-class
#' @export
setMethod("boutput", "NULL", function(x) NULL )



#' @rdname Bclass-class
#' @export
setGeneric("boutput<-", function(x, value) standardGeneric("boutput<-"))


#' @rdname Bclass-class
#' @export
setMethod("boutput<-", "Bclass", function(x, value){
  
  # x <- Bclass(results = bresults(x), output = value, caption = bcaption(x), header = bheader(x))
  
  x@output <- value
  
  validObject(x)
  
  x
  
})





### caption


#' @rdname Bclass-class
#' @export
setGeneric("bcaption", function(x, ...) standardGeneric("bcaption"))


#' @rdname Bclass-class
#' @export
setMethod("bcaption", "Bclass", function(x) x@caption )


#' @rdname Bclass-class
#' @export
setMethod("bcaption", "NULL", function(x) NULL )


#' @rdname Bclass-class
#' @export
setGeneric("bcaption<-", function(x, value) standardGeneric("bcaption<-"))


#' @rdname Bclass-class
#' @export
setMethod("bcaption<-", "Bclass", function(x, value){
  
  # x <- Bclass(results = bresults(x), output = boutput(x), caption = value, header = bheader(x))
  
  x@caption <- value
  
  validObject(x)
  
  x
  
})


### header


#' @rdname Bclass-class
#' @export
setGeneric("bheader", function(x, ...) standardGeneric("bheader"))


#' @rdname Bclass-class
#' @export
setMethod("bheader", "Bclass", function(x) x@header )


#' @rdname Bclass-class
#' @export
setMethod("bheader", "NULL", function(x) NULL )


#' @rdname Bclass-class
#' @export
setGeneric("bheader<-", function(x, value) standardGeneric("bheader<-"))


#' @rdname Bclass-class
#' @export
setMethod("bheader<-", "Bclass", function(x, value){
  
  # x <- Bclass(results = bresults(x), output = boutput(x), caption = bcaption(x), header = value)
  
  x@header <- value
  
  validObject(x)
  
  x
  
})




################################################################################
### Other methods
################################################################################


#' @rdname Bclass-class
#' @export
setMethod("dim", "Bclass", function(x){
  
  dim(x@output)
  
})


#' @rdname Bclass-class
#' @export
setMethod("nrow", "Bclass", function(x){
  
  nrow(x@output)
  
})



#' @rdname Bclass-class
#' @export
setMethod("ncol", "Bclass", function(x){
  
  ncol(x@output)
  
})




#' @rdname Bclass-class
#' @export
setMethod("colnames", "Bclass", function(x){
  
  colnames(x@output)
  
})

#' @rdname Bclass-class
#' @export
setMethod("colnames<-", "Bclass", function(x, value){
  
  colnames(x@output) <- value
  x
  
})



#' @rdname Bclass-class
#' @export
setMethod("rownames", "Bclass", function(x){
  
  rownames(x@output)
  
})


#' @rdname Bclass-class
#' @export
setMethod("rownames<-", "Bclass", function(x, value){
  
  rownames(x@output) <- value
  rownames(x@results) <- value
  
  validObject(x)
  
  x
  
})



###############################################################################
### Subsetting methods
###############################################################################



#' @aliases [[,Bclass-method
#' @rdname Bclass-class
#' @export
setMethod("[[", signature(x = "Bclass"), function(x, i, j){
  
  x@output[[i]]
  
})


#' @rdname Bclass-class
#' @export
setMethod("$", "Bclass", function(x, name){
  
  x@output[[name]]
  
})




#' @aliases [,Bclass-method [,Bclass,ANY-method
#' @rdname Bclass-class
#' @export
setMethod("[", signature(x = "Bclass"), function(x, i, j){
  ## No subsetting columns in results. Only rows.
  
  if(!missing(i)){
    
    if(!missing(j)){
      
      if(!is.null(bheader(x))){
        ## TODO I have to update the calculation of header
        new_header <- NULL
      }else{
        new_header <- bheader(x)
      }
      
      new_results <- bresults(x)[i, , drop = FALSE]
      new_output <- boutput(x)[i, j, drop = FALSE]
      
      
      # x <- Bclass(results = new_results, 
      #   output = new_output, 
      #   caption = bcaption(x), 
      #   header = new_header)
      
      
      x@results <- new_results
      x@output <- new_output
      x@header <- new_header
      
      validObject(x)
      
      return(x)
      
      
    }else{
      
      
      new_results <- bresults(x)[i, , drop = FALSE]
      new_output <- boutput(x)[i, , drop = FALSE]
      
      # x <- Bclass(results = new_results, 
      #   output = new_output, 
      #   caption = bcaption(x), 
      #   header = bheader(x))
      
      x@results <- new_results
      x@output <- new_output
      
      validObject(x)
      
      return(x)
      
    } 
    
  }else{
    
    if(!missing(j)){
      
      if(!is.null(bheader(x))){
        ## TODO I have to update the calculation of header
        new_header <- NULL
      }else{
        new_header <- bheader(x)
      }
      
      new_output <- boutput(x)[, j, drop = FALSE]
      
      # x <- Bclass(results = bresults(x), 
      #   output = new_output, 
      #   caption = bcaption(x), 
      #   header = new_header)
      
      
      x@output <- new_output
      x@header <- new_header
      
      validObject(x)
      
      return(x)
      
      
    }else{
      
      return(x)
      
    } 
    
  }
  
})



###############################################################################
### rbind, cbind methods
###############################################################################

# getGeneric("rbind")
# showMethods("rbind")
# getMethod("rbind", "DataFrame")



#' @rdname Bclass-class
#' @export
setMethod("rbind", "Bclass", function(..., deparse.level = 1){
  
  listData <- list(...)
  
  if(length(listData) == 1L && is.list(listData[[1L]])){
    listData <- listData[[1L]]
  }
  
  
  if(length(listData) == 0L){
    return()
  }
  
  if(length(listData) == 1L){
    return(listData[[1]])
  }
  
  
  ### All the objects have to be of the same class.
  listData_class <- unique(sapply(listData, class))
  
  if(length(listData_class) > 1){
    stop("All elements in '...' must be of the same class.")
  }
  
  ### Caption and header are preserved from the first element
  new_caption <- bcaption(listData[[1]])
  new_header <- bheader(listData[[1]])
  
  
  new_results <- do.call(rbind, lapply(listData, bresults))
  new_output <- do.call(rbind, lapply(listData, boutput))
  
  
  x <- new(listData_class, results = new_results, 
    output = new_output,
    caption = new_caption,
    header = new_header)
  
  
  return(x)
  
  
})




#' @rdname Bclass-class
#' @export
setMethod("cbind", "Bclass", function(..., deparse.level = 1){
  
  listData <- list(...)
  
  if(length(listData) == 1L && is.list(listData[[1L]])){
    listData <- listData[[1L]]
  }
  
  if(length(listData) == 0L){
    return()
  }
  
  if(length(listData) == 1L){
    return(listData[[1]])
  }
  
  
  ### All the objects have to be of the same class.
  listData_class <- unique(sapply(listData, class))
  
  if(length(listData_class) > 1){
    stop("All elements in '...' must be of the same class.")
  }
  
  ### Caption is preserved from the first element
  ### Header is set to NULL
  new_caption <- bcaption(listData[[1]])
  new_header <- NULL
  
  
  new_results <- do.call(cbind, lapply(listData, bresults))
  new_output <- do.call(cbind, lapply(listData, boutput))
  
  
  x <- new(listData_class, results = new_results, 
    output = new_output,
    caption = new_caption,
    header = new_header)
  
  
  return(x)
  
  
})


































